package com.sdp.self_rpc_done.serviceProviderExp;import com.sdp.self_rpc_done.protoEntity.request;import com.sdp.self_rpc_done.publicInterface.*;import io.netty.channel.ChannelHandlerContext;import io.netty.channel.ChannelInboundHandlerAdapter;import java.util.concurrent.*;import java.util.concurrent.atomic.AtomicInteger;/*************************************************** * Copyright (C) didi_global                       * FileName:         serverHandler                       * Author:           Sun Dongpo                    * Date:             2020/4/4 下午12:08               * Description:      服务器端的请求处理器                * Tele:             15029155474                   * mail:             sundongpo_i@didiglobal.com    ************************************************** */public class ExpServerHandler extends ChannelInboundHandlerAdapter{    private ThreadPoolExecutor threadPool;    private ChannelHandlerContext ctx;    //初始化当前实例的时候初始化线程池    public ExpServerHandler(int workThread) {        //创建阻塞队列        BlockingQueue<Runnable> blockingQueue = new ArrayBlockingQueue<>(100);        //自定义线程创建工厂        ThreadFactory threadFactory = new ThreadFactory() {            AtomicInteger count = new AtomicInteger(0);            @Override            public Thread newThread(Runnable r) {                Thread t = new Thread(r);                t.setName("rpc_"+count.getAndIncrement());                return t;            }        };        threadPool = new ThreadPoolExecutor(Runtime.getRuntime().availableProcessors(),                workThread,10, TimeUnit.SECONDS,blockingQueue,threadFactory);    }    //比较优雅的关闭线程池    public void closeGracefully(){        threadPool.shutdown();        try {            threadPool.awaitTermination(10,TimeUnit.SECONDS);        } catch (InterruptedException e) {            e.printStackTrace();        }        threadPool.shutdownNow();    }    @Override    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {        //对输入的数据进行强制类型转换        request.RequestBody msgInput = (request.RequestBody) msg;        System.out.println("[Exp]  "+msgInput.toString()+"...");        //返回给客户端的消息        System.err.println("********");        handlerMessage(msgInput);    }    //消息处理器    public void handlerMessage(request.RequestBody messageInput){        request.SelfReq payload = messageInput.getReq();        new ExpRequestHandler().handle(ctx,messageInput.getType(),payload);    }    @Override    public void channelActive(ChannelHandlerContext ctx) throws Exception {        this.ctx = ctx;    }    @Override    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {        cause.printStackTrace();        ctx.channel().close();        this.closeGracefully();    }}